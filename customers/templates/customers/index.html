{% extends 'base.html' %}
{% load static %}

{% block title %}Customers{% endblock %}

{% block body %}

<div class="flex justify-between items-center">
    <div>
        <form class="gap-5 flex items-center" method="GET">
            <div class="flex gap-2 w-min">
                <label for="created-date" class="text-right text-wrap">Created Date</label>
                <input class="p-2 bg-bg border-1 rounded-sm" type="date" id="created-date" name="created-date" value="{{ request.GET.created_date }}">
            </div>
            <div class="flex gap-2 items-center">
                <label for="source">Source</label>
                <select class="pl-1 py-2 pr-3 bg-bg border-1 rounded-sm" name="source" id="source">
                    {% for source in sources %}
                        <option value="{{ source.name }}">{{ source.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="hover:cursor-pointer p-1 bg-brand-400 shadow text-sm flex items-center gap-1">Apply <img width="12px" height="12px" src="/static/img/Filter.svg" alt="Filter Icon"></button>
        </form>
    </div>
    <div>
        <button id="newLeadBtn" class="px-3 py-2 bg-brand-400 hover:cursor-pointer flex items-center gap-2" id="addLead">New Lead <img src="/static/img/NewLead.svg" alt="Add Lead Icon" height="20px" width="20px"></button>
    </div>
</div>

<div class="p-5 rounded-lg bg-bg shadow space-y-4 overflow-x-scroll">
    <h2 class="text-text font-bold text-3xl">Lead List</h2>
    <hr>
    <table class="w-full text-text text-lg border-separate border-spacing-y-2">
        <thead class="text-left bg-brand-100 sticky top-0">
            <tr>
                <th class="p-3 font-normal text-nowrap">Name</th>
                <th class="p-3 font-normal text-nowrap">Company Name</th>
                <th class="p-3 font-normal text-nowrap">Email</th>
                <th class="p-3 font-normal text-nowrap">Phone</th>
                <th class="p-3 font-normal text-nowrap">Source</th>
                <th class="p-3 font-normal text-nowrap">Lead Status</th>
                <th class="p-3 font-normal text-nowrap">Assigned To</th>
                <th class="p-3 font-normal text-nowrap">Last Contacted</th>
                <th class="p-3 font-normal text-nowrap">Next Follow-up Date</th>
                <th class="p-3 font-normal text-nowrap">Value</th>
                <th class="p-3 font-normal text-nowrap">Created At</th>
            </tr>
        </thead>
        <tbody>
            {% for customer in customers %}
                <tr class="group">
                    <td class="p-3 text-nowrap"><p class="relative">
                        {{ customer.first_name }} {{ customer.last_name }}
                        <a class="hidden group-hover:block absolute top-0 left-[-30px] z-50 p-1 border-1 bg-bg shadow-sm" href="/customer/{{ customer.id }}"><img width="20px" height="20px" src="/static/img/PersonIcon.svg" alt="Edit Icon"></a>
                    </p></td>
                    {% if customer.company.company_name %}
                    <td class="p-3 text-nowrap"><p class="relative group">
                    {{ customer.company.company_name }}
                    <a href="company/{{ customer.company.id }}" class="hidden group-hover:block absolute top-0 left-[-30px] z-50 p-1 border-1 bg-bg shadow-sm"><img width="20px" height="20px" src="/static/img/business.svg" alt="Business Icon"></a>
                    </p></td>

                    {% else %}
                    <td class="p-3 text-nowrap">No Details</td>
                    {% endif %}
                    <td class="p-3 text-nowrap">{{ customer.email }}</td>
                    <td class="p-3 text-nowrap">{{ customer.phone_number }}</td>
                    <td class="p-3 text-nowrap">{{ customer.source.name }}</td>
                    <td class="p-3 text-nowrap">
                        <select class="pl-1 py-1 pr-2 text-sm bg-bg border-1 rounded-sm">
                            {% for status in lead_status %}
                                <option value="{{ status.id }}"
                                    {% if customer.lead_status.id == status.id %}selected{% endif %}>
                                    {{ status.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td class="p-3 text-nowrap">
                        <div class="h-[40px] overflow-y-scroll space-y-1">
                            {% for user in customer.assigned_to.all %}
                                <div class="flex items-center gap-2">
                                    {% include 'components/user.html' %}
                                </div>
                            {% endfor %}
                        </div>
                    </td>
                    <td class="p-3">
                        <input
                            type="date"
                            value="{{ customer.last_contact|date:'Y-m-d'|default:'' }}"
                            data-id="{{ customer.id }}"
                            data-field="last_contact"
                            onchange="updateCustomerDate(this)"
                            class="bg-transparent border-none text-sm text-gray-700 focus:ring-brand-400 rounded-sm p-1 hover:bg-gray-100 cursor-pointer"
                        >
                    </td>

                    <td class="p-3">
                        <input
                            type="date"
                            value="{{ customer.next_contact|date:'Y-m-d'|default:'' }}"
                            data-id="{{ customer.id }}"
                            data-field="next_contact"
                            onchange="updateCustomerDate(this)"
                            class="bg-transparent border-none text-sm text-gray-700 focus:ring-brand-400 rounded-sm p-1 hover:bg-gray-100 cursor-pointer"
                        >
                    </td>
                    {% if customer.value %}
                    <td class="p-3 text-nowrap">{{ customer.value }}â‚¬</td>
                    {% else  %}
                    <td class="p-3 text-nowrap text-center">-</td>
                    {% endif %}
                    <td class="p-3 text-nowrap">{{ customer.created_at }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- START -- NEW LEAD FORM -->
<div id="newLeadFormOverlay" class="z-20 hidden p-5 rounded-lg bg-bg shadow space-y-4 overflow-y-scroll absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
    <h2 class="text-2xl text-text">Add Lead:</h2>
    <hr>
    <form id="newLeadForm" method="POST" action="">
        {% csrf_token %}
        <section class="grid grid-cols-2 items-center gap-6 p-2">
            <div class="flex flex-col">
                <label for="firstName" class="text-sm font-medium text-text">First Name:</label>
                <input type="text" placeholder="First Name" name="firstName" id="firstName"
                       class="border border-gray-300 rounded px-2 py-1">
            </div>

            <div class="flex flex-col">
                <label for="lastName" class="text-sm font-medium text-text">Last Name:</label>
                <input type="text" placeholder="Last Name" name="lastName" id="lastName"
                       class="border border-gray-300 rounded px-2 py-1">
            </div>
        </section>
        <section class="grid grid-cols-1 items-center gap-6 p-2">
            <div class="flex flex-col">
                <label for="email" class="text-sm font-medium text-text">Email:</label>
                <input type="email" placeholder="Email" name="email" id="email"
                       class="border border-gray-300 rounded px-2 py-1">
            </div>
        </section>
        <section class="grid grid-cols-2 items-center gap-6 mb-4 p-2">
            <div class="flex flex-col">
                <label for="phoneNumber" class="text-sm font-medium text-text">Phone:</label>
                <input type="text" placeholder="Phone number" name="phoneNumber" id="phoneNumber"
                       class="border border-gray-300 rounded px-2 py-1">
            </div>
            <div class="flex flex-col">
                <label for="value" class="text-sm font-medium text-text">Value:<span class="text-gray-400">(Optional)</span></label>
                <input type="number" step="0.01" placeholder="Value" name="value" id="value"
                       class="border border-gray-300 rounded px-2 py-1">
            </div>
            <div class="flex flex-col">
                <label for="last_contact" class="text-sm font-medium text-text">Last Contact:<span class="text-gray-400">(Optional)</span></label>
                <input type="date" name="last_contact" id="last_contact"
                       class="border border-gray-300 rounded px-2 py-1">
            </div>
            <div class="flex flex-col">
                <label for="follow_up_date" class="text-sm font-medium text-text">Follow Up Date:<span class="text-gray-400">(Optional)</span></label>
                <input type="date" name="follow_up_date" id="follow_up_date"
                       class="border border-gray-300 rounded px-2 py-1">
            </div>
        </section>

        <section class="flex items-center gap-6 mb-4 p-2">
        <div class="flex gap-3 items-center">
        <label for="new_source">Source</label>
        <select id="new_source" name="source" class="pl-1 py-1 pr-2 text-sm bg-bg border-1 rounded-sm">
          {% for source in sources %}
            <option value="{{ source.id }}">{{ source.name }}</option>
          {% endfor %}
        </select>
        </div>
        <div class="flex gap-3 items-center">
        <label for="new_lead_status">Lead Status</label>
        <select id="new_lead_status" name="lead_status" class="pl-1 py-1 pr-2 text-sm bg-bg border-1 rounded-sm">
          {% for status in lead_status %}
            <option value="{{ status.id }}">{{ status.name }}</option>
          {% endfor %}
        </select>
        </div>
        </section>

        <section>
            <input type="checkbox" id="companyDetailsFlag" name="companyDetailsFlag">
            <label for="companyDetailsFlag">For Company?</label>
            <div id="companyDetailsForm" class="hidden grid grid-cols-1 items-center gap-3 mt-3 mb-6">

                <div class="flex flex-col">
                <label for="companyName" class="text-sm font-medium text-text">Company Name:</label>
                <input type="text" placeholder="Company Name" name="companyName" id="companyName"
                       class="border border-gray-300 rounded px-2 py-1">
                </div>
                <div class="flex flex-col">
                <label for="vatID" class="text-sm font-medium text-text">VAT ID:</label>
                <input type="text" placeholder="VAT ID" name="vatID" id="vatID"
                       class="border border-gray-300 rounded px-2 py-1">
                </div>

            </div>
        </section>

        <div class="flex justify-end">
            <button id="createLeadBtn" type="submit" class="px-3 py-2 bg-brand-400 hover:cursor-pointer">Create Lead</button>
        </div>
    </form>
</div>
<div class="absolute top-0 left-0 w-full h-full z-10 bg-black opacity-5 hidden" id="backgroundOverlay"></div>

{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/customers.js' %}"></script>
{% endblock %}